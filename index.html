<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Architect - V4.7</title>
    
    <!-- Core Libraries (React + Tailwind) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom scrollbar for filmstrip preview */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Safe area for mobile bottom nav */
        .safe-bottom { padding-bottom: calc(4rem + env(safe-area-inset-bottom)); }
        
        /* Privacy Badge Animation */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        .privacy-dot { animation: pulse-green 2s infinite; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- Icon Component System ---
        const Icons = {
            Layout: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>,
            Settings: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Folder: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 2H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/></svg>,
            Download: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Upload: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            User: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Mail: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>,
            Palette: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></svg>,
            Sliders: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" x2="4" y1="21" y2="14"/><line x1="4" x2="4" y1="10" y2="3"/><line x1="12" x2="12" y1="21" y2="12"/><line x1="12" x2="12" y1="8" y2="3"/><line x1="20" x2="20" y1="21" y2="16"/><line x1="20" x2="20" y1="12" y2="3"/><line x1="2" x2="6" y1="14" y2="14"/><line x1="10" x2="14" y1="8" y2="8"/><line x1="18" x2="22" y1="16" y2="16"/></svg>,
            FileArchive: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 22V4c0-.5.2-1 .6-1.4C5 2.2 5.5 2 6 2h8.5L20 7.5V20c0 .5-.2 1-.6 1.4-.4.4-.9.6-1.4.6h-2"/><path d="M14 2v6h6"/><path d="M10 20v-1a2 2 0 1 1 4 0v1"/><path d="M4 8h12"/><path d="M4 16h12"/></svg>,
            HelpCircle: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>,
            Zap: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            ArrowRight: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            Monitor: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></svg>,
            Linkedin: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/><rect width="4" height="12" x="2" y="9"/><circle cx="4" cy="4" r="2"/></svg>,
            Github: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>,
            Twitter: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.6 3 5c2.2 2.6 5.6 4.1 9 4-.9-4.2 4-6.6 7-3.8 1.1 0 3-1.2 3-1.2z"/></svg>,
            Trash2: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Video: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>,
            Play: (props) => <svg {...props} viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Lock: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
        };

        const Icon = ({ name, size = 18, className = "" }) => {
            const Component = Icons[name];
            return Component ? <Component width={size} height={size} className={className} /> : null;
        };

        const DEFAULT_CONFIG = {
            title: "", // Empty by default
            subtitle: "",
            email: "",
            website: "",
            linkedin: "",
            github: "",
            twitter: "",
            bio: "", // Empty by default
            accentColor: "#2563eb",
            dark_mode: false,
            layout: 'masonry',
            gridFit: false,
            groupByFolder: true, // Default to True
            sortBy: 'name', 
            font: 'sans',
            filter: 'none',
            vignetteStrength: 0,
            cornerRadius: 10, // Default 10px
            imageScale: 100,
            output: {
                embedImages: false,
                maxDimension: 1200,
                quality: 0.75,
                stripRoot: true, 
            },
        };

        function App() {
            // -- CHANGED: Initialize Config State from LocalStorage with Fallback --
            const [config, setConfig] = useState(() => {
                const saved = localStorage.getItem('portfolio_architect_v4_config');
                // Merge default with saved to ensure new keys (like stripRoot) are present
                return saved ? { ...DEFAULT_CONFIG, ...JSON.parse(saved) } : DEFAULT_CONFIG;
            });
            
            // -- CHANGED: Initialize Logo State from LocalStorage --
            const [logo, setLogo] = useState(() => {
                return localStorage.getItem('portfolio_architect_v4_logo') || null;
            });
            
            const [files, setFiles] = useState([]);
            const [activeTab, setActiveTab] = useState('config');
            const [showWelcome, setShowWelcome] = useState(true);
            const [status, setStatus] = useState({ state: 'idle', message: '', progress: 0 });
            
            const isQuickStartRef = useRef(false);
            const dirInputRef = useRef(null);

            // -- CHANGED: Persist Config changes to LocalStorage --
            useEffect(() => {
                localStorage.setItem('portfolio_architect_v4_config', JSON.stringify(config));
            }, [config]);
            
            // -- CHANGED: Persist Logo changes to LocalStorage --
            useEffect(() => {
                try {
                    if (logo) {
                        localStorage.setItem('portfolio_architect_v4_logo', logo);
                    } else {
                        localStorage.removeItem('portfolio_architect_v4_logo');
                    }
                } catch (e) {
                    console.error("Failed to save logo to local storage", e);
                }
            }, [logo]);

            const handleConfigChange = (e) => {
                const { name, value, type, checked } = e.target;
                setConfig(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
            };

            const updateOutput = (key, value) => {
                setConfig(prev => ({ ...prev, output: { ...prev.output, [key]: value } }));
            };

            const handleLogoUpload = (e) => {
                const file = e.target.files?.[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setLogo(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            const handleQuickStart = () => {
                isQuickStartRef.current = true;
                if (dirInputRef.current) {
                    dirInputRef.current.click();
                }
            };
            
            const handleFolderSelect = (e) => {
                const fileList = e.target.files;
                if (!fileList || fileList.length === 0) {
                    isQuickStartRef.current = false;
                    return;
                }

                // -- CHANGED: Clear input so "onChange" fires again even if same folder selected --
                
                const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg'];
                const videoExtensions = ['.mp4', '.webm', '.mov', '.ogg'];
                const foundFiles = [];
                let detectedRoot = '';

                // Robust root detection
                for(let i=0; i<fileList.length; i++) {
                    const path = fileList[i].webkitRelativePath || fileList[i].name;
                    const parts = path.split('/');
                    if(parts.length > 1) {
                        detectedRoot = parts[0];
                        break; 
                    }
                }

                Array.from(fileList).forEach((file) => {
                    const lowerName = file.name.toLowerCase();
                    const isImage = imageExtensions.some(ext => lowerName.endsWith(ext));
                    const isVideo = videoExtensions.some(ext => lowerName.endsWith(ext));

                    if (isImage || isVideo) {
                        const pathParts = (file.webkitRelativePath || file.name).split('/');
                        const folder = pathParts.length > 1 ? pathParts[pathParts.length - 2] : 'General';
                        
                        foundFiles.push({
                            name: file.name,
                            path: file.webkitRelativePath || file.name,
                            size: file.size,
                            lastModified: file.lastModified,
                            type: isVideo ? 'video' : 'image',
                            folder: folder,
                            originalFile: file
                        });
                    }
                });

                // Beautify bio name
                const bioName = detectedRoot ? detectedRoot.replace(/_/g, ' ') : "Portfolio";
                
                let nextConfig = { ...config };

                // Apply Quick Start Defaults or Update Bio if needed
                if (isQuickStartRef.current) {
                    // Prompt for Title immediately
                    let userTitle = prompt("Please enter your Name or Portfolio Title:", "");
                    if (userTitle === null) userTitle = ""; // Handle cancel

                    nextConfig = {
                        ...config,
                        title: userTitle,
                        subtitle: "",
                        email: "",
                        website: "",
                        linkedin: "",
                        github: "",
                        twitter: "",
                        bio: "", // Clear Bio
                        groupByFolder: true,
                        output: { ...config.output, embedImages: false, stripRoot: true }
                    };
                } else {
                    if (config.bio === DEFAULT_CONFIG.bio && bioName !== "Portfolio") {
                         // Standard mode: If user didn't change title/bio, maybe update?
                         // User asked for empty by default in standard mode.
                         // So we don't autofill unless Quick Start.
                    }
                }

                // Update State for UI
                setConfig(nextConfig);
                setFiles(foundFiles);
                
                if (foundFiles.length > 0 && !isQuickStartRef.current) setActiveTab('files');
                
                // POPUP REMINDER for Standard Mode Placement (Applied to BOTH Quick Start and Custom)
                if (!nextConfig.output.embedImages) {
                        alert(`âš ï¸ IMPORTANT PLACEMENT RULE\n\nTo ensure your images load correctly, you MUST save the generated HTML file INSIDE the folder you just selected:\n\nðŸ“‚ ${detectedRoot || "Your Selected Folder"}\n\nDo not save it in 'Downloads' or outside this folder.`);
                }

                // FORCE AUTO-SAVE LOGIC
                if (isQuickStartRef.current || !nextConfig.output.embedImages) {
                    // Trigger async generation but do NOT reset isQuickStartRef yet
                    generateHTML(foundFiles, nextConfig);
                    
                    if(isQuickStartRef.current) {
                        setShowWelcome(false);
                    }
                }

                // -- CHANGED: Reset input value here --
                if(e.target) e.target.value = null;
            };

            const removeFile = (indexToRemove) => {
                setFiles(prev => prev.filter((_, index) => index !== indexToRemove));
            };

            const compressImage = (file, maxDim, quality) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            if (width > height) {
                                if (width > maxDim) { height *= maxDim / width; width = maxDim; }
                            } else {
                                if (height > maxDim) { width *= maxDim / height; height = maxDim; }
                            }
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        };
                        img.onerror = reject;
                        img.src = event.target?.result;
                    };
                    reader.readAsDataURL(file);
                });
            };

            const getVideoThumbnail = (file) => {
                return new Promise((resolve) => {
                    const video = document.createElement('video');
                    video.preload = 'metadata';
                    video.src = URL.createObjectURL(file);
                    video.muted = true;
                    video.currentTime = 1; 
                    
                    video.onloadeddata = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        const maxDim = 800;
                        if(canvas.width > maxDim || canvas.height > maxDim) {
                            const scale = maxDim / Math.max(canvas.width, canvas.height);
                            canvas.width *= scale;
                            canvas.height *= scale;
                        }
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        URL.revokeObjectURL(video.src);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    video.onerror = () => resolve(null); 
                });
            };

            // Accepts overrides for immediate execution
            const generateHTML = async (filesOverride = null, configOverride = null) => {
                const currentFiles = filesOverride || files;
                const currentConfig = configOverride || config;

                setStatus({ state: 'processing', message: 'Sorting & Organizing...', progress: 5 });

                let sortedFiles = [...currentFiles];
                if (currentConfig.sortBy === 'date') {
                    sortedFiles.sort((a, b) => b.lastModified - a.lastModified);
                } else {
                    sortedFiles.sort((a, b) => a.name.localeCompare(b.name));
                }

                const processedFiles = [];
                const total = sortedFiles.length;
                
                for (let i = 0; i < total; i++) {
                    setStatus({ state: 'processing', message: `Processing ${i + 1}/${total}`, progress: Math.round(((i + 1) / total) * 100) });
                    const f = sortedFiles[i];
                    
                    try {
                        let src = '';
                        let isEmbedded = false;

                        if (currentConfig.output.embedImages) {
                            if (f.type === 'video') {
                                src = await getVideoThumbnail(f.originalFile);
                            } else {
                                src = await compressImage(f.originalFile, currentConfig.output.maxDimension, currentConfig.output.quality);
                            }
                            isEmbedded = true;
                        } else {
                            // Standard Mode logic - ALWAYS strip root folder to allow internal linking
                            const parts = f.path.split('/');
                            if (parts.length > 1) {
                                // Strip root folder (e.g. "Root/Sub/Img.jpg" -> "Sub/Img.jpg")
                                parts.shift();
                                src = `./${parts.join('/')}`;
                            } else {
                                // Fallback if no subfolder
                                src = `./${f.name}`;
                            }
                        }

                        processedFiles.push({
                            ...f,
                            src: src || '', 
                            isEmbedded
                        });
                    } catch (e) {
                        console.error("Error processing", f.name, e);
                    }
                }

                let contentStructure = {};
                if (currentConfig.groupByFolder) {
                    processedFiles.forEach(f => {
                        const group = f.folder;
                        if (!contentStructure[group]) contentStructure[group] = [];
                        contentStructure[group].push(f);
                    });
                } else {
                    contentStructure['Gallery'] = processedFiles;
                }

                setStatus({ state: 'processing', message: 'Compiling Portfolio...', progress: 100 });

                let fontStack = '"Inter", sans-serif';
                 switch (currentConfig.font) {
                    case 'serif': fontStack = '"Merriweather", "Georgia", serif'; break;
                    case 'editorial': fontStack = '"Playfair Display", "Didot", serif'; break;
                    case 'humanist': fontStack = '"Lato", "Open Sans", sans-serif'; break;
                    case 'mono': fontStack = '"Inconsolata", "Courier New", monospace'; break;
                    case 'geometric': fontStack = '"Century Gothic", "Futura", sans-serif'; break;
                    case 'slab': fontStack = '"Rockwell", "Roboto Slab", serif'; break;
                    case 'system': fontStack = 'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'; break;
                    case 'wide': fontStack = '"Verdana", "Geneva", sans-serif'; break;
                    case 'oldstyle': fontStack = '"Garamond", "Baskerville", "Times New Roman", serif'; break;
                    case 'screenplay': fontStack = '"Courier Prime", "Courier", monospace'; break;
                }

                const filters = {
                    none: '', grayscale: 'grayscale(100%)', sepia: 'sepia(80%)', vivid: 'saturate(150%)',
                    matte: 'brightness(110%) contrast(90%) saturate(90%)', vintage: 'sepia(40%) saturate(140%) hue-rotate(-20deg)',
                    cinematic: 'contrast(110%) saturate(120%) hue-rotate(-10deg)',
                };
                const filterCss = filters[currentConfig.filter];
                const vignetteStrength = Number(currentConfig.vignetteStrength);
                const vignetteCss = vignetteStrength > 0 ? `
                    .gallery-item::after {
                        content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                        background: radial-gradient(circle, transparent 50%, rgba(0,0,0,${vignetteStrength / 100}) 100%);
                        pointer-events: none;
                    }
                ` : '';

                let layoutCss = '';
                const objectFit = currentConfig.gridFit ? 'contain' : 'cover';
                const itemBg = currentConfig.gridFit ? 'color-mix(in srgb, var(--accent) 15%, var(--card-bg))' : 'var(--card-bg)';
                const radius = `${currentConfig.cornerRadius}px`;
                const baseScale = currentConfig.imageScale / 100;
                const baseSize = Math.floor(300 * baseScale);

                if (currentConfig.layout === 'masonry') {
                    layoutCss = `
                        .gallery-container { column-count: 1; column-gap: 1.5rem; }
                        @media (min-width: ${Math.floor(baseSize * 2)}px) { .gallery-container { column-count: 2; } }
                        @media (min-width: ${Math.floor(baseSize * 3)}px) { .gallery-container { column-count: 3; } }
                        @media (min-width: ${Math.floor(baseSize * 4)}px) { .gallery-container { column-count: 4; } }
                        @media (min-width: ${Math.floor(baseSize * 5)}px) { .gallery-container { column-count: 5; } }
                        .gallery-item { break-inside: avoid; margin-bottom: 1.5rem; overflow: hidden; border-radius: ${radius}; }
                        .gallery-item img, .gallery-item video { display: block; width: 100%; height: auto; }
                    `;
                } else if (currentConfig.layout === 'single') {
                    layoutCss = `
                        .gallery-container { display: flex; flex-direction: column; gap: 4rem; max-width: ${Math.min(800 * baseScale, 1400)}px; margin: 0 auto; }
                        .gallery-item { width: 100%; box-shadow: none; border: none; background: transparent; overflow: hidden; border-radius: ${radius}; }
                        .gallery-item img, .gallery-item video { width: 100%; height: auto; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
                        .gallery-item:hover { transform: none; box-shadow: none; }
                    `;
                } else if (currentConfig.layout === 'filmstrip') {
                    layoutCss = `
                        .gallery-container { display: flex; overflow-x: auto; gap: 1.5rem; padding-bottom: 2rem; scroll-snap-type: x mandatory; align-items: center; }
                        .gallery-container::-webkit-scrollbar { height: 8px; }
                        .gallery-container::-webkit-scrollbar-track { background: var(--card-bg); border-radius: 4px; }
                        .gallery-container::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 4px; }
                        .gallery-item { flex: 0 0 ${Math.min(85 * baseScale, 90)}vw; height: ${Math.min(60 * baseScale, 80)}vh; scroll-snap-align: center; border-radius: ${radius}; overflow: hidden; background-color: ${itemBg}; display: flex; align-items: center; justify-content: center; }
                        @media(min-width: 768px) { .gallery-item { flex: 0 0 ${Math.min(60 * baseScale, 80)}vw; height: ${Math.min(70 * baseScale, 90)}vh; } }
                        .gallery-item img, .gallery-item video { width: 100%; height: 100%; object-fit: ${objectFit}; }
                    `;
                } else if (currentConfig.layout === 'dual') {
                    layoutCss = `
                        .gallery-container { display: grid; grid-template-columns: 1fr; gap: 2rem; max-width: ${Math.min(1400 * baseScale, 1800)}px; margin: 0 auto; }
                        @media(min-width: 768px) { .gallery-container { grid-template-columns: 1fr 1fr; } }
                        .gallery-item { overflow: hidden; border-radius: ${radius}; background-color: ${itemBg}; }
                        .gallery-item img, .gallery-item video { width: 100%; height: auto; display: block; }
                    `;
                } else {
                    layoutCss = `
                        .gallery-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(${baseSize}px, 1fr)); gap: 1.5rem; }
                        .gallery-item { aspect-ratio: 1 / 1; overflow: hidden; background-color: ${itemBg}; display: flex; align-items: center; justify-content: center; border-radius: ${radius}; }
                        .gallery-item img, .gallery-item video { width: 100%; height: 100%; object-fit: ${objectFit}; }
                    `;
                }

                const htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${currentConfig.title}</title>
    <style>
        :root { --accent: ${currentConfig.accentColor}; --bg: ${currentConfig.dark_mode ? '#0f172a' : '#ffffff'}; --text: ${currentConfig.dark_mode ? '#f3f4f6' : '#1f2937'}; --card-bg: ${currentConfig.dark_mode ? '#1e293b' : '#f9fafb'}; --border: ${currentConfig.dark_mode ? '#334155' : '#e2e8f0'}; --font-main: ${fontStack}; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-main); background-color: var(--bg); color: var(--text); line-height: 1.6; padding-bottom: 4rem; }
        a { color: var(--accent); text-decoration: none; font-weight: 500; }
        .wrapper { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        
        header { padding: 4rem 0 2rem; border-bottom: 1px solid var(--border); margin-bottom: 3rem; }
        .logo { height: 80px; width: auto; border-radius: 8px; margin-right: 2rem; float: left; }
        h1 { font-size: 3rem; font-weight: 800; letter-spacing: -0.02em; line-height: 1; }
        h2 { font-size: 1.25rem; color: var(--accent); font-weight: 500; margin-top: 0.5rem; }
        .bio { max-width: 600px; opacity: 0.8; font-size: 1.1rem; margin-top: 1rem; }
        .meta { display: flex; gap: 1.5rem; margin-top: 1.5rem; flex-wrap: wrap; font-size: 0.9rem; opacity: 0.7; }

        .section-title { font-size: 1.5rem; font-weight: 700; margin: 3rem 0 1.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border); text-transform: capitalize; }
        
        ${layoutCss}
        ${vignetteCss}
        
        .gallery-item { position: relative; transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: pointer; }
        .gallery-item:hover { transform: translateY(-4px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); }
        .gallery-item img, .gallery-item video { filter: ${filterCss}; transition: filter 0.3s ease; }
        .gallery-item:hover img, .gallery-item:hover video { filter: none; }

        .video-badge {
            position: absolute; bottom: 10px; right: 10px;
            background: rgba(0,0,0,0.6); color: white;
            padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;
            display: flex; align-items: center; gap: 4px; pointer-events: none;
        }

        #lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 2rem; }
        #lightbox.active { display: flex; }
        #lightbox img, #lightbox video { max-width: 90%; max-height: 90%; border-radius: 4px; box-shadow: 0 0 40px rgba(0,0,0,0.5); }
        .close-btn { position: absolute; top: 20px; right: 30px; color: white; font-size: 3rem; cursor: pointer; z-index: 1001; }
        
        footer { margin-top: 5rem; padding-top: 2rem; border-top: 1px solid var(--border); text-align: center; }
        .copyright { font-size: 0.875rem; opacity: 0.7; margin-bottom: 0.5rem; }
        .credit { font-size: 0.75rem; opacity: 0.5; font-style: italic; }
        
        .gallery-container { -ms-overflow-style: none; scrollbar-width: none; } 
    </style>
</head>
<body>
    <div class="wrapper">
        <header>
            ${logo ? `<img src="${logo}" class="logo" alt="Logo">` : ''}
            <h1>${currentConfig.title}</h1>
            <h2>${currentConfig.subtitle}</h2>
            ${currentConfig.bio ? `<p class="bio">${currentConfig.bio}</p>` : ''}
            <div class="meta">
                ${currentConfig.email ? `<span>${currentConfig.email}</span>` : ''}
                ${currentConfig.website ? `<span>${currentConfig.website}</span>` : ''}
            </div>
        </header>

        ${Object.entries(contentStructure).map(([folderName, items]) => `
            ${currentConfig.groupByFolder ? `<h3 class="section-title">${folderName.replace(/_/g, ' ')}</h3>` : ''}
            <div class="gallery-container">
                ${items.map(file => {
                    const isVideo = file.type === 'video';
                    const renderVideo = isVideo && !currentConfig.output.embedImages;
                    return `
                    <div class="gallery-item" onclick="${renderVideo ? '' : `openLightbox('${file.src}', ${isVideo})`}">
                        ${renderVideo 
                            ? `<video src="${file.src}" controls preload="metadata"></video>` 
                            : `<img src="${file.src}" loading="lazy" alt="${file.name}">`
                        }
                        ${isVideo ? `<div class="video-badge">â–¶ Video</div>` : ''}
                    </div>
                    `
                }).join('')}
            </div>
        `).join('')}

        <footer>
            <p class="copyright">&copy; ${new Date().getFullYear()} ${currentConfig.title}</p>
            <p class="credit">Generated with Portfolio Architect</p>
        </footer>
    </div>
    
    <div id="lightbox" onclick="closeLightbox(event)">
        <span class="close-btn">&times;</span>
        <div id="lb-content"></div>
    </div>

    <script>
        const lb = document.getElementById('lightbox');
        const lbContent = document.getElementById('lb-content');
        function openLightbox(src, isVideo) { 
            lb.classList.add('active'); 
            document.body.style.overflow = 'hidden';
            lbContent.innerHTML = '<img src="' + src + '">';
        }
        function closeLightbox(e) { 
            if(e.target === lb || e.target.classList.contains('close-btn')) { 
                lb.classList.remove('active'); 
                document.body.style.overflow = ''; 
                lbContent.innerHTML = ''; 
            } 
        }
        document.addEventListener('keydown', e => { if(e.key === 'Escape') lb.click(); });
        
        const containers = document.querySelectorAll('.gallery-container');
        containers.forEach(container => {
            if(window.getComputedStyle(container).overflowX === 'auto') {
                container.addEventListener('wheel', (evt) => {
                    evt.preventDefault();
                    container.scrollLeft += evt.deltaY;
                });
            }
        });
    <\/script>
</body>
</html>`;

                // Calculate smart filename
                let filename = 'index.html';
                if (currentConfig.output.embedImages) {
                    filename = 'portfolio_bundle.html';
                } else if (currentConfig.title) {
                    filename = currentConfig.title.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.html';
                }

                // Smart Save Dialog (File System Access API)
                if (!currentConfig.output.embedImages && window.showSaveFilePicker) {
                    try {
                        const handle = await window.showSaveFilePicker({
                            suggestedName: filename,
                            types: [{
                                description: 'HTML File',
                                accept: {'text/html': ['.html']},
                            }],
                        });
                        const writable = await handle.createWritable();
                        await writable.write(htmlContent);
                        await writable.close();
                        setStatus({ state: 'idle', message: '', progress: 0 });
                        
                        // Force reload for Quick Start mode after successful save
                        if (isQuickStartRef.current) {
                            setTimeout(() => window.location.reload(), 2000);
                        }
                        
                        return; // Exit if successful
                    } catch (err) {
                        // User cancelled or API not supported/allowed in iframe, fall back to blob download
                        console.log("FS Access API unavailable or cancelled", err);
                    }
                }

                // Fallback / Standard Download
                const blob = new window.Blob([htmlContent], { type: 'text/html' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                setStatus({ state: 'idle', message: '', progress: 0 });
                
                // Force reload for Quick Start mode after fallback download
                if (isQuickStartRef.current) {
                    setTimeout(() => window.location.reload(), 2000);
                }
            };

            return (
                <div className="flex flex-col md:flex-row h-screen bg-slate-50 text-slate-900 font-sans overflow-hidden">
                  
                  {/* Hidden Input */}
                  <input ref={dirInputRef} type="file" webkitdirectory="true" directory="" multiple onChange={handleFolderSelect} className="hidden" />

                  {/* Welcome Modal */}
                  {showWelcome && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 animate-in fade-in duration-300">
                       <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden border border-slate-200">
                          <div className="bg-slate-50 p-6 border-b border-slate-100 text-center relative">
                             <button onClick={() => setShowWelcome(false)} className="absolute right-4 top-4 text-slate-400 hover:text-slate-600 transition-colors">
                                 <Icon name="ArrowRight" size={24} className="rotate-45" />
                             </button>
                             <div className="w-14 h-14 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm">
                                <Icon name="Zap" size={28} />
                             </div>
                             <h2 className="text-xl font-bold text-slate-900">Welcome to Portfolio Architect</h2>
                             <p className="text-slate-500 mt-2 text-sm">Create a professional local portfolio in 3 steps.</p>
                          </div>
                          <div className="p-6 space-y-6">
                             <div className="flex gap-4 group">
                                <div className="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold shrink-0 shadow-sm group-hover:scale-110 transition-transform">1</div>
                                <div>
                                   <h3 className="font-semibold text-slate-900 text-sm">Configure Identity</h3>
                                   <p className="text-xs text-slate-500 mt-1">Set your name, bio, and visual preferences in the Configuration tab.</p>
                                </div>
                             </div>
                             <div className="flex gap-4 group">
                                <div className="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold shrink-0 shadow-sm group-hover:scale-110 transition-transform">2</div>
                                <div>
                                   <h3 className="font-semibold text-slate-900 text-sm">Select Image Folder</h3>
                                   <p className="text-xs text-slate-500 mt-1">Scan local images & videos securely. Nothing is uploaded.</p>
                                </div>
                             </div>
                             <div className="flex gap-4 group">
                                <div className="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold shrink-0 shadow-sm group-hover:scale-110 transition-transform">3</div>
                                <div>
                                   <h3 className="font-semibold text-slate-900 text-sm">Generate & Deploy</h3>
                                   <p className="text-xs text-slate-500 mt-1">Export a standalone HTML file. Save it inside your image folder.</p>
                                </div>
                             </div>
                          </div>
                          <div className="p-4 border-t border-slate-100 bg-slate-50 flex gap-3">
                             <button onClick={handleQuickStart} className="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg font-semibold text-sm shadow-md transition-all flex items-center justify-center gap-2 group">
                                <Icon name="Zap" size={16} /> Quick Start
                             </button>
                             <button onClick={() => setShowWelcome(false)} className="flex-1 bg-white hover:bg-slate-50 border border-slate-200 text-slate-700 px-4 py-2.5 rounded-lg font-semibold text-sm shadow-sm transition-all">
                                Custom Setup
                             </button>
                          </div>
                          <div className="bg-slate-50 px-6 py-3 text-center border-t border-slate-100 text-[10px] text-slate-400">
                             <span className="flex items-center justify-center gap-1"><Icon name="Lock" size={10} /> Local Processing Only. No files uploaded.</span>
                          </div>
                       </div>
                    </div>
                  )}

                  {/* Sidebar */}
                  <div className="hidden md:flex w-64 bg-white border-r border-slate-200 overflow-y-auto flex-col h-full">
                        <div className="p-4 border-b border-slate-100">
                            <div className="flex items-center gap-3 mb-1">
                                <div className="bg-slate-900 text-white p-2 rounded-lg"><Icon name="Layout" size={20} /></div>
                                <div>
                                    <h1 className="text-lg font-bold leading-tight">Portfolio Architect</h1>
                                    <p className="text-xs text-slate-500 font-medium">V4.7 Pro</p>
                                </div>
                            </div>
                            <div className="mt-2 text-[10px] text-green-600 bg-green-50 border border-green-200 rounded px-2 py-1 flex items-center gap-2">
                                <div className="w-1.5 h-1.5 rounded-full bg-green-500 privacy-dot"></div>
                                Local / Offline Mode
                            </div>
                        </div>
                        <div className="p-2 space-y-1 mt-2">
                            <button onClick={() => setActiveTab('config')} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-sm font-medium transition-colors ${activeTab === 'config' ? 'bg-slate-100 text-slate-900' : 'text-slate-500 hover:bg-slate-50'}`}>
                                <Icon name="Settings" size={18} /> Configuration
                            </button>
                            <button onClick={() => setActiveTab('files')} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-sm font-medium transition-colors ${activeTab === 'files' ? 'bg-slate-100 text-slate-900' : 'text-slate-500 hover:bg-slate-50'}`}>
                                <Icon name="Folder" size={18} /> Assets {files.length > 0 && <span className="ml-auto bg-slate-200 px-1.5 rounded-full text-xs">{files.length}</span>}
                            </button>
                        </div>
                  </div>

                  {/* Main Content */}
                  <div className="flex-1 overflow-y-auto p-4 md:p-8 bg-slate-50/50 pt-16 md:pt-8 safe-bottom">
                      <div className="max-w-4xl mx-auto space-y-6">
                        
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-slate-800">{activeTab === 'config' ? 'Configuration' : 'Asset Management'}</h2>
                            {config.output.embedImages ? (
                                <button onClick={() => generateHTML()} disabled={files.length === 0 || status.state === 'processing'}
                                    className={`flex items-center gap-2 px-6 py-2.5 rounded-lg font-semibold transition-all ${files.length ? 'bg-blue-600 text-white hover:bg-blue-700 shadow-md' : 'bg-slate-100 text-slate-400'}`}>
                                    {status.state === 'processing' ? <span className="flex gap-2"><div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"/> {status.progress}%</span> : <><Icon name="Download" size={18} /> Generate Portfolio</>}
                                </button>
                            ) : null}
                        </div>

                            {activeTab === 'config' && (
                                <React.Fragment>
                                    <section className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm space-y-4">
                                        <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2"><Icon name="User" size={14} /> Identity</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <input type="text" name="title" value={config.title} onChange={handleConfigChange} placeholder="Full Name" className="border rounded-md px-3 py-2 text-sm w-full"/>
                                            <input type="text" name="subtitle" value={config.subtitle} onChange={handleConfigChange} placeholder="Job Title" className="border rounded-md px-3 py-2 text-sm w-full"/>
                                            <textarea name="bio" value={config.bio} onChange={handleConfigChange} placeholder="Professional Bio" rows={2} className="border rounded-md px-3 py-2 text-sm w-full md:col-span-2 resize-none"/>
                                            
                                            <div className="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-3 pt-2">
                                                <input type="email" name="email" value={config.email} onChange={handleConfigChange} placeholder="Email" className="border rounded-md px-3 py-2 text-xs w-full"/>
                                                <input type="text" name="website" value={config.website} onChange={handleConfigChange} placeholder="Website URL" className="border rounded-md px-3 py-2 text-xs w-full"/>
                                            </div>

                                            <div className="md:col-span-2 flex items-center gap-4 border-t pt-4">
                                                <label className="flex items-center gap-2 text-sm font-medium text-slate-600 cursor-pointer hover:text-slate-900">
                                                    <Icon name="Upload" size={16} /> {logo ? 'Change Logo' : 'Upload Logo'}
                                                    <input type="file" accept="image/*" onChange={handleLogoUpload} className="hidden" />
                                                </label>
                                                {logo && <img src={logo} className="h-8 w-8 rounded object-cover border" alt="logo prev"/>}
                                            </div>
                                        </div>
                                    </section>

                                    <section className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm space-y-6">
                                        <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2"><Icon name="Palette" size={14} /> Design System</h3>
                                        
                                        <div>
                                            <label className="text-xs font-semibold text-slate-500 mb-3 block">Gallery Structure</label>
                                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                                                <button onClick={() => setConfig(p => ({...p, layout: 'masonry'}))} className={`p-3 rounded-lg border text-left hover:border-blue-400 transition-all ${config.layout === 'masonry' ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500' : 'border-slate-200'}`}>
                                                    <div className="flex gap-1 mb-2 opacity-50"><div className="w-1.5 h-4 bg-current rounded-sm"/><div className="w-1.5 h-6 bg-current rounded-sm mt-2"/><div className="w-1.5 h-3 bg-current rounded-sm"/></div>
                                                    <div className="text-xs font-semibold">Masonry</div>
                                                </button>
                                                <button onClick={() => setConfig(p => ({...p, layout: 'grid'}))} className={`p-3 rounded-lg border text-left hover:border-blue-400 transition-all ${config.layout === 'grid' ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500' : 'border-slate-200'}`}>
                                                    <div className="grid grid-cols-2 gap-1 mb-2 opacity-50 w-6"><div className="h-2.5 bg-current rounded-sm"/><div className="h-2.5 bg-current rounded-sm"/><div className="h-2.5 bg-current rounded-sm"/><div className="h-2.5 bg-current rounded-sm"/></div>
                                                    <div className="text-xs font-semibold">Grid</div>
                                                </button>
                                                <button onClick={() => setConfig(p => ({...p, layout: 'single'}))} className={`p-3 rounded-lg border text-left hover:border-blue-400 transition-all ${config.layout === 'single' ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500' : 'border-slate-200'}`}>
                                                    <div className="flex flex-col gap-1 mb-2 opacity-50 w-6"><div className="h-2.5 bg-current rounded-sm w-full"/><div className="h-2.5 bg-current rounded-sm w-full"/></div>
                                                    <div className="text-xs font-semibold">Journal</div>
                                                </button>
                                                <button onClick={() => setConfig(p => ({...p, layout: 'filmstrip'}))} className={`p-3 rounded-lg border text-left hover:border-blue-400 transition-all ${config.layout === 'filmstrip' ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500' : 'border-slate-200'}`}>
                                                    <div className="flex gap-1 mb-2 opacity-50 overflow-hidden w-6"><div className="h-5 w-4 bg-current rounded-sm flex-shrink-0"/><div className="h-5 w-4 bg-current rounded-sm flex-shrink-0"/></div>
                                                    <div className="text-xs font-semibold">Filmstrip</div>
                                                </button>
                                                <button onClick={() => setConfig(p => ({...p, layout: 'dual'}))} className={`p-3 rounded-lg border text-left hover:border-blue-400 transition-all ${config.layout === 'dual' ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500' : 'border-slate-200'}`}>
                                                    <div className="flex gap-1 mb-2 opacity-50 w-6"><div className="h-5 w-full bg-current rounded-sm"/><div className="h-5 w-full bg-current rounded-sm"/></div>
                                                    <div className="text-xs font-semibold">Dual</div>
                                                </button>
                                            </div>
                                            {config.layout === 'grid' && (
                                                <label className="mt-2 flex items-center gap-2 text-xs text-slate-600"><input type="checkbox" checked={config.gridFit} onChange={e => setConfig(p => ({...p, gridFit: e.target.checked}))}/> Fit images inside squares</label>
                                            )}
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <label className="text-xs font-semibold text-slate-500 mb-2 block">Typography</label>
                                                <select name="font" value={config.font} onChange={handleConfigChange} className="w-full px-3 py-2 border border-slate-300 rounded-md text-sm">
                                                    <option value="sans">Modern Sans (Inter)</option>
                                                    <option value="serif">Classic Serif (Georgia)</option>
                                                    <option value="mono">Code (Inconsolata)</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="text-xs font-semibold text-slate-500 mb-2 block">Accent Colour</label>
                                                <div className="flex flex-wrap gap-2">
                                                    {['#2563eb', '#0f172a', '#dc2626', '#16a34a', '#7c3aed'].map(c => (
                                                        <button key={c} onClick={() => setConfig(p => ({...p, accentColor: c}))} className={`w-6 h-6 rounded-full border ${config.accentColor === c ? 'ring-2 ring-slate-400' : 'border-transparent'}`} style={{ backgroundColor: c }} />
                                                    ))}
                                                    <input type="color" value={config.accentColor} onChange={e => setConfig(p => ({...p, accentColor: e.target.value}))} className="w-6 h-6 rounded-full p-0 border-0"/>
                                                </div>
                                                <div className="mt-3 pt-2">
                                                    <label className="flex items-center gap-2 text-sm font-medium text-slate-700 cursor-pointer">
                                                        <input type="checkbox" checked={config.dark_mode} onChange={e => setConfig(p => ({...p, dark_mode: e.target.checked}))} className="rounded border-slate-300"/>
                                                        Enable Dark Mode
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </section>

                                    <section className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm space-y-6">
                                        <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2"><Icon name="Sliders" size={14} /> Post-Processing</h3>
                                        <div>
                                            <label className="text-xs font-semibold text-slate-500 mb-3 block">Image Filters</label>
                                            <div className="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
                                                {['none', 'grayscale', 'sepia', 'vivid', 'matte', 'vintage', 'cinematic'].map(f => (
                                                    <button key={f} onClick={() => setConfig(p => ({...p, filter: f}))} 
                                                        className={`px-3 py-1.5 rounded-full text-xs font-medium capitalize border transition-all ${config.filter === f ? 'bg-slate-800 text-white border-slate-800' : 'bg-white border-slate-200 text-slate-600 hover:border-slate-300'}`}>
                                                        {f}
                                                    </button>
                                                ))}
                                            </div>
                                            
                                            <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-slate-100 pt-4">
                                                <div>
                                                    <div className="flex justify-between items-center mb-2">
                                                        <label className="text-xs font-semibold text-slate-500">Vignette</label>
                                                        <span className="text-xs text-slate-400 font-mono">{config.vignetteStrength}%</span>
                                                    </div>
                                                    <input type="range" name="vignetteStrength" min="0" max="100" value={config.vignetteStrength} onChange={handleConfigChange} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"/>
                                                </div>
                                                <div>
                                                    <div className="flex justify-between items-center mb-2">
                                                        <label className="text-xs font-semibold text-slate-500">Corner Radius</label>
                                                        <span className="text-xs text-slate-400 font-mono">{config.cornerRadius}px</span>
                                                    </div>
                                                    <input type="range" name="cornerRadius" min="0" max="24" value={config.cornerRadius} onChange={handleConfigChange} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"/>
                                                </div>
                                                <div className="md:col-span-2">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <label className="text-xs font-semibold text-slate-500">Scale / Density</label>
                                                        <span className="text-xs text-slate-400 font-mono">{config.imageScale}%</span>
                                                    </div>
                                                    <input type="range" name="imageScale" min="50" max="150" value={config.imageScale} onChange={handleConfigChange} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"/>
                                                </div>
                                            </div>
                                        </div>
                                    </section>

                                    <section className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm space-y-4">
                                        <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2"><Icon name="Folder" size={14} /> Organization</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <label className="flex items-center gap-3 p-3 rounded-lg border bg-slate-50 cursor-pointer">
                                                <input type="checkbox" name="groupByFolder" checked={config.groupByFolder} onChange={handleConfigChange} className="mt-1"/>
                                                <div>
                                                    <span className="text-sm font-bold text-slate-900 block">Group by Folder</span>
                                                    <span className="text-xs text-slate-500 block">Creates sections based on folder names.</span>
                                                </div>
                                            </label>
                                            
                                            <div>
                                                <label className="text-xs font-semibold text-slate-500 mb-2 block">Sort Order</label>
                                                <select name="sortBy" value={config.sortBy} onChange={handleConfigChange} className="w-full px-3 py-2 border border-slate-300 rounded-md text-sm">
                                                    <option value="name">Name (A-Z)</option>
                                                    <option value="date">Date (Newest First)</option>
                                                </select>
                                            </div>
                                        </div>
                                    </section>
                                    
                                        <div className="pt-4 border-t border-slate-100">
                                            <label className="flex items-start gap-3 p-3 rounded-lg border bg-slate-50 cursor-pointer">
                                                <input type="checkbox" checked={config.output.embedImages} onChange={e => updateOutput('embedImages', e.target.checked)} className="mt-1"/>
                                                <div className="flex-1">
                                                    <span className="text-sm font-bold text-slate-900 block flex items-center gap-2"><Icon name="FileArchive" size={14} /> Portable Mode</span>
                                                    <span className="text-xs text-slate-500 block">Embeds images & video thumbnails into HTML. Easier to share.</span>
                                                    {config.output.embedImages && (
                                                        <div className="mt-3 grid grid-cols-2 gap-4 animate-in fade-in">
                                                            <div>
                                                                <span className="text-xs font-semibold block mb-1">Max Width</span>
                                                                <select value={config.output.maxDimension} onChange={e => updateOutput('maxDimension', Number(e.target.value))} className="w-full text-xs border rounded px-2 py-1">
                                                                    <option value="800">800px (Email)</option>
                                                                    <option value="1200">1200px (Web)</option>
                                                                    <option value="1920">1920px (HD)</option>
                                                                </select>
                                                            </div>
                                                            <div>
                                                                <span className="text-xs font-semibold block mb-1">Quality</span>
                                                                <select value={config.output.quality} onChange={e => updateOutput('quality', Number(e.target.value))} className="w-full text-xs border rounded px-2 py-1">
                                                                    <option value="0.6">Low (60%)</option>
                                                                    <option value="0.8">High (80%)</option>
                                                                    <option value="1.0">Max (100%)</option>
                                                                </select>
                                                            </div>
                                                            <div className="col-span-2 text-xs text-amber-600 bg-amber-50 p-2 rounded">
                                                                <strong>Note:</strong> Videos will be replaced by static screenshots.
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </label>
                                            
                                            {!config.output.embedImages && (
                                                <div className="mt-3 p-3 rounded bg-blue-50 border border-blue-100 text-xs text-blue-700">
                                                    <strong>Important:</strong> Save the generated HTML file <u>inside</u> the folder you selected ("{files[0]?.path ? files[0].path.split('/')[0] : 'your folder'}") to ensure links work.
                                                </div>
                                            )}
                                        </div>
                                </React.Fragment>
                            )}

                            {activeTab === 'files' && (
                                <div className="bg-white p-8 rounded-xl border-2 border-dashed border-slate-300 flex flex-col items-center justify-center text-center">
                                    <div className="bg-blue-50 p-4 rounded-full mb-4 text-blue-600"><Icon name="Folder" size={32} /></div>
                                    <h3 className="text-lg font-bold text-slate-900 mb-2">Select Image Folder</h3>
                                    <p className="text-slate-500 text-sm mb-6 max-w-sm">
                                        Supports Images (JPG, PNG) and Videos (MP4, MOV).
                                    </p>
                                    <button onClick={() => dirInputRef.current?.click()} className="px-6 py-2 bg-slate-900 text-white rounded-lg text-sm font-bold hover:bg-slate-800">
                                        {!config.output.embedImages ? 'Select Folder & Generate HTML' : 'Browse Folder'}
                                    </button>
                                    
                                    {files.length > 0 && (
                                        <div className="mt-8 w-full border rounded-lg overflow-hidden text-left">
                                            <div className="bg-slate-50 px-4 py-2 border-b text-xs font-semibold text-slate-500 flex justify-between">
                                                <span>Found {files.length} items</span>
                                                {config.groupByFolder && <span>Grouped by Folder</span>}
                                            </div>
                                            <div className="max-h-64 overflow-y-auto p-2 space-y-1">
                                                {files.map((f, i) => (
                                                    <div key={i} className="flex justify-between items-center text-xs px-2 py-1 hover:bg-slate-50 rounded group">
                                                        <div className="flex items-center gap-2 flex-1 overflow-hidden">
                                                            {f.type === 'video' ? <Icon name="Video" size={14} className="text-blue-500"/> : <Icon name="Monitor" size={14} className="text-slate-400"/>}
                                                            <span className="truncate">{f.folder} / {f.name}</span>
                                                        </div>
                                                        <span className="text-slate-400 mono mr-3">{(f.size/1024/1024).toFixed(2)}MB</span>
                                                        
                                                        {/* Restored Remove Button */}
                                                        {/* Remove Button - Always Visible */}
                                                        <button 
                                                            onClick={(e) => { e.stopPropagation(); removeFile(i); }} 
                                                            className="p-1 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded transition-colors"
                                                            title="Remove file"
                                                        >
                                                            <Icon name="Trash2" size={14} />
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                  </div>

                  <div className="md:hidden fixed bottom-0 w-full bg-white border-t border-slate-200 flex justify-around p-2 pb-safe z-40">
                      <button onClick={() => setActiveTab('config')} className={`flex flex-col items-center gap-1 p-2 rounded-lg ${activeTab === 'config' ? 'text-blue-600' : 'text-slate-500'}`}><Icon name="Settings" size={20} /><span className="text-[10px]">Config</span></button>
                      <button onClick={() => setActiveTab('files')} className={`flex flex-col items-center gap-1 p-2 rounded-lg ${activeTab === 'files' ? 'text-blue-600' : 'text-slate-500'}`}><Icon name="Folder" size={20} /><span className="text-[10px]">Assets</span></button>
                  </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
